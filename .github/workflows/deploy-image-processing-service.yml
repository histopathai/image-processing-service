name: Deploy Image Processing Service

on:
  push:
    branches:
      - main
      - dev
    paths:
      - "**"
      - ".github/workflows/deploy-image-processing-service.yml"
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy"
        required: true
        type: choice
        options:
          - dev
          - prod

env:
  TF_VERSION: "1.5.0"
  REPO_NAME: image-processing-service

permissions:
  contents: read
  id-token: write

jobs:
  setup:
    name: Setup Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
    steps:
      - name: Determine Environment
        id: set-env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENV="${{ inputs.environment }}"
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            ENV="prod"
          elif [ "${{ github.ref }}" == "refs/heads/dev" ]; then
            ENV="dev"
          else
            ENV="dev"
          fi

          echo "environment=${ENV}" >> $GITHUB_OUTPUT
          echo "ğŸŒ Environment: ${ENV}"

  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: setup
    env:
      ENVIRONMENT: ${{ needs.setup.outputs.environment }}
      WIF_PROVIDER: ${{ secrets.WIF_PROVIDER}}
      WIF_SERVICE_ACCOUNT: ${{ secrets.WIF_SERVICE_ACCOUNT}}
      TF_STATE_BUCKET: ${{ secrets.TF_STATE_BUCKET }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WIF_PROVIDER }}
          service_account: ${{ env.WIF_SERVICE_ACCOUNT }}

      - name: Set up Google Cloud CLI
        uses: google-github-actions/setup-gcloud@v2

      - name: Get GCP Project Info
        id: gcp-info
        run: |
          PROJECT_ID=$(gcloud config get-value project)
          REGION="${{ secrets.GCP_REGION }}"

          echo "project_id=${PROJECT_ID}" >> $GITHUB_OUTPUT
          echo "region=${REGION}" >> $GITHUB_OUTPUT

          echo "ğŸ“¦ Project ID: ${PROJECT_ID}"
          echo "ğŸŒ Region: ${REGION}"

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ steps.gcp-info.outputs.region }}-docker.pkg.dev

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24.0"

      - name: Run Unit Tests
        run: go test -v ./...

      - name: Build Docker Image
        run: |
          IMAGE_TAG="${{ steps.gcp-info.outputs.region }}-docker.pkg.dev/${{ steps.gcp-info.outputs.project_id }}/${{ secrets.ARTIFACT_REGISTRY_REPO_NAME }}/${{ env.REPO_NAME }}:${{ github.sha }}"
          IMAGE_LATEST="${{ steps.gcp-info.outputs.region }}-docker.pkg.dev/${{ steps.gcp-info.outputs.project_id }}/${{ secrets.ARTIFACT_REGISTRY_REPO_NAME }}/${{ env.REPO_NAME }}:latest"
          IMAGE_ENV="${{ steps.gcp-info.outputs.region }}-docker.pkg.dev/${{ steps.gcp-info.outputs.project_id }}/${{ secrets.ARTIFACT_REGISTRY_REPO_NAME }}/${{ env.REPO_NAME }}:${{ env.ENVIRONMENT }}"

          docker build \
            --tag ${IMAGE_TAG} \
            --tag ${IMAGE_LATEST} \
            --tag ${IMAGE_ENV} \
            .

          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "ğŸ³ Built image: ${IMAGE_TAG}"

      - name: Push Docker Image
        run: |
          IMAGE_TAG="${{ steps.gcp-info.outputs.region }}-docker.pkg.dev/${{ steps.gcp-info.outputs.project_id }}/${{ secrets.ARTIFACT_REGISTRY_REPO_NAME }}/${{ env.REPO_NAME }}:${{ github.sha }}"
          IMAGE_LATEST="${{ steps.gcp-info.outputs.region }}-docker.pkg.dev/${{ steps.gcp-info.outputs.project_id }}/${{ secrets.ARTIFACT_REGISTRY_REPO_NAME }}/${{ env.REPO_NAME }}:latest"
          IMAGE_ENV="${{ steps.gcp-info.outputs.region }}-docker.pkg.dev/${{ steps.gcp-info.outputs.project_id }}/${{ secrets.ARTIFACT_REGISTRY_REPO_NAME }}/${{ env.REPO_NAME }}:${{ env.ENVIRONMENT }}"

          docker push ${IMAGE_TAG}
          docker push ${IMAGE_LATEST}
          docker push ${IMAGE_ENV}

          echo "ğŸš€ Pushed all image tags"

      - name: Output Image Info
        id: image-info
        run: |
          IMAGE_TAG="${{ steps.gcp-info.outputs.region }}-docker.pkg.dev/${{ steps.gcp-info.outputs.project_id }}/${{ secrets.ARTIFACT_REGISTRY_REPO_NAME }}/${{ env.REPO_NAME }}:${{ github.sha }}"
          echo "image=${IMAGE_TAG}" >> $GITHUB_OUTPUT

    outputs:
      image: ${{ steps.image-info.outputs.image }}
      project_id: ${{ steps.gcp-info.outputs.project_id }}
      region: ${{ steps.gcp-info.outputs.region }}

  terraform-deploy:
    name: Terraform Deploy
    runs-on: ubuntu-latest
    needs: [setup, build-and-push]
    environment:
      name: ${{ needs.setup.outputs.environment }}

    env:
      WIF_PROVIDER: ${{ secrets.WIF_PROVIDER}}
      WIF_SERVICE_ACCOUNT: ${{ secrets.WIF_SERVICE_ACCOUNT}}
      TF_STATE_BUCKET: ${{ secrets.TF_STATE_BUCKET }}
      ARTIFACT_REGISTRY_REPO_NAME: ${{ secrets.ARTIFACT_REGISTRY_REPO_NAME }}
      GCP_REGION: ${{ secrets.GCP_REGION }}

    defaults:
      run:
        working-directory: ./infrastructure

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WIF_PROVIDER }}
          service_account: ${{ env.WIF_SERVICE_ACCOUNT }}

      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Verify GCP Authentication
        run: |
          echo "ğŸ” Authenticated as:"
          gcloud auth list
          echo ""
          echo "ğŸ“¦ Current project:"
          gcloud config get-value project
          echo ""
          echo "ğŸŒ Environment: ${{ needs.setup.outputs.environment }}"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        run: |
          echo "ğŸ”§ Initializing Terraform for ${{ needs.setup.outputs.environment }}..."
          terraform init \
            -backend-config="bucket=${{ env.TF_STATE_BUCKET }}" \
            -backend-config="prefix=services/image-processing-service/${{ needs.setup.outputs.environment }}"

      - name: Cleanup Terraform State
        run: |
          echo "ğŸ§¹ Checking for state drift..."
          chmod +x cleanup_state.sh
          ./cleanup_state.sh "${{ needs.setup.outputs.environment }}"
        env:
          TF_STATE_BUCKET: ${{ env.TF_STATE_BUCKET }}
          GCP_REGION: ${{ env.GCP_REGION }}

      - name: Terraform Plan
        run: |
          echo "ğŸ“Š Running Terraform plan..."

          terraform plan \
          -var="image_tag=${{ github.sha }}" \
          -var="environment=${{ needs.setup.outputs.environment }}" \
          -var="tf_state_bucket=${{ env.TF_STATE_BUCKET }}" \
          -out=tfplan

      - name: Terraform Apply
        run: |
          echo "ğŸš€ Applying Terraform changes for ${{ needs.setup.outputs.environment }}..."
          terraform apply -auto-approve tfplan

      - name: Terraform Output
        id: tf-output
        run: |
          echo "ğŸ“¤ Terraform Outputs:"
          terraform output -json > terraform-outputs.json
          cat terraform-outputs.json

          echo "âœ… Cloud Run Jobs deployed"

      - name: Upload Terraform Outputs
        uses: actions/upload-artifact@v4
        with:
          name: terraform-outputs-${{ needs.setup.outputs.environment }}
          path: infrastructure/terraform-outputs.json
          retention-days: 30

      - name: Cleanup Sensitive Files
        if: always()
        run: rm -f terraform.tfvars tfplan

      - name: Deployment Summary
        run: |
          echo "ğŸ‰ Deployment completed successfully!"
          echo "ğŸŒ Environment: ${{ needs.setup.outputs.environment }}"
          echo "ğŸ³ Image: ${{ needs.build-and-push.outputs.image }}"
          echo "ğŸ”§ 3 Cloud Run Jobs deployed (small, medium, large)"

  notify:
    name: Notify Deployment
    runs-on: ubuntu-latest
    needs: [setup, build-and-push, terraform-deploy]
    if: always()

    steps:
      - name: Deployment Status
        run: |
          if [ "${{ needs.terraform-deploy.result }}" == "success" ]; then
            echo "âœ… Deployment successful!"
            echo "ğŸŒ Environment: ${{ needs.setup.outputs.environment }}"
            echo "ğŸ”§ Cloud Run Jobs: small, medium, large"
          else
            echo "âŒ Deployment failed!"
            echo "ğŸŒ Environment: ${{ needs.setup.outputs.environment }}"
            exit 1
          fi
