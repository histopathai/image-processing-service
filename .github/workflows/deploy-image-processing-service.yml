name: Deploy Image Processing Service

on:
  push:
    branches:
      - main
      - dev
    paths:
      - 'image-processing-service/**'
      - '.github/workflows/deploy-image-processing-service.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - dev
          - prod

env:
  TF_VERSION: '1.5.0'
  REPO_NAME: image-processing-service
  
permissions:
  contents: read
  id-token: write

jobs:
  setup:
    name: Setup Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
    steps:
      - name: Determine Environment
        id: set-env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENV="${{ inputs.environment }}"
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            ENV="prod"
          elif [ "${{ github.ref }}" == "refs/heads/dev" ]; then
            ENV="dev"
          else
            ENV="dev"
          fi
          
          echo "environment=${ENV}" >> $GITHUB_OUTPUT

  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: setup
    defaults:
      run:
        working-directory: ./image-processing-service
    env:
      ENVIRONMENT: ${{ needs.setup.outputs.environment }}
      WIF_PROVIDER: ${{ (needs.setup.outputs.environment == 'prod') && secrets.WIF_PROVIDER_PROD || secrets.WIF_PROVIDER_DEV }}
      WIF_SERVICE_ACCOUNT: ${{ (needs.setup.outputs.environment == 'prod') && secrets.WIF_SERVICE_ACCOUNT_PROD || secrets.WIF_SERVICE_ACCOUNT_DEV }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WIF_PROVIDER }}
          service_account: ${{ env.WIF_SERVICE_ACCOUNT }}

      - name: Set up Google Cloud CLI
        uses: google-github-actions/setup-gcloud@v2

      - name: Get GCP Project Info
        id: gcp-info
        run: |
          PROJECT_ID=$(gcloud config get-value project)
          PROJECT_NUMBER=$(gcloud projects describe ${PROJECT_ID} --format="value(projectNumber)")
          REGION="${{ secrets.GCP_REGION }}"
          
          echo "project_id=${PROJECT_ID}" >> $GITHUB_OUTPUT
          echo "project_number=${PROJECT_NUMBER}" >> $GITHUB_OUTPUT
          echo "region=${REGION}" >> $GITHUB_OUTPUT

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ steps.gcp-info.outputs.region }}-docker.pkg.dev

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.0'
      
      - name: Run Unit Tests
        run: go test -v ./...

      - name: Build Docker Image
        id: build
        run: |
          IMAGE_TAG="${{ steps.gcp-info.outputs.region }}-docker.pkg.dev/${{ steps.gcp-info.outputs.project_id }}/${{ secrets.ARTIFACT_REGISTRY_REPO_NAME }}/${{ env.REPO_NAME }}:${{ github.sha }}"
          IMAGE_LATEST="${{ steps.gcp-info.outputs.region }}-docker.pkg.dev/${{ steps.gcp-info.outputs.project_id }}/${{ secrets.ARTIFACT_REGISTRY_REPO_NAME }}/${{ env.REPO_NAME }}:latest"
          IMAGE_ENV="${{ steps.gcp-info.outputs.region }}-docker.pkg.dev/${{ steps.gcp-info.outputs.project_id }}/${{ secrets.ARTIFACT_REGISTRY_REPO_NAME }}/${{ env.REPO_NAME }}:${{ env.ENVIRONMENT }}"
          
          docker build \
            --tag ${IMAGE_TAG} \
            --tag ${IMAGE_LATEST} \
            --tag ${IMAGE_ENV} \
            .
          
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT

      - name: Push Docker Image
        run: |
          IMAGE_TAG="${{ steps.gcp-info.outputs.region }}-docker.pkg.dev/${{ steps.gcp-info.outputs.project_id }}/${{ secrets.ARTIFACT_REGISTRY_REPO_NAME }}/${{ env.REPO_NAME }}:${{ github.sha }}"
          IMAGE_LATEST="${{ steps.gcp-info.outputs.region }}-docker.pkg.dev/${{ steps.gcp-info.outputs.project_id }}/${{ secrets.ARTIFACT_REGISTRY_REPO_NAME }}/${{ env.REPO_NAME }}:latest"
          IMAGE_ENV="${{ steps.gcp-info.outputs.region }}-docker.pkg.dev/${{ steps.gcp-info.outputs.project_id }}/${{ secrets.ARTIFACT_REGISTRY_REPO_NAME }}/${{ env.REPO_NAME }}:${{ env.ENVIRONMENT }}"
          
          docker push ${IMAGE_TAG}
          docker push ${IMAGE_LATEST}
          docker push ${IMAGE_ENV}

      - name: Output Image Info
        id: image-info
        run: |
          IMAGE_TAG="${{ steps.gcp-info.outputs.region }}-docker.pkg.dev/${{ steps.gcp-info.outputs.project_id }}/${{ secrets.ARTIFACT_REGISTRY_REPO_NAME }}/${{ env.REPO_NAME }}:${{ github.sha }}"
          echo "image=${IMAGE_TAG}" >> $GITHUB_OUTPUT

    outputs:
      image: ${{ steps.image-info.outputs.image }}
      project_id: ${{ steps.gcp-info.outputs.project_id }}
      project_number: ${{ steps.gcp-info.outputs.project_number }}
      region: ${{ steps.gcp-info.outputs.region }}

  terraform-deploy:
    name: Terraform Deploy
    runs-on: ubuntu-latest
    needs: [setup, build-and-push]
    environment:
      name: ${{ needs.setup.outputs.environment }}
    
    env:
      WIF_PROVIDER: ${{ (needs.setup.outputs.environment == 'prod') && secrets.WIF_PROVIDER_PROD || secrets.WIF_PROVIDER_DEV }}
      WIF_SERVICE_ACCOUNT: ${{ (needs.setup.outputs.environment == 'prod') && secrets.WIF_SERVICE_ACCOUNT_PROD || secrets.WIF_SERVICE_ACCOUNT_DEV }}
      TF_VARS_JSON: ${{ (needs.setup.outputs.environment == 'prod') && secrets.TF_VAR_PROD || secrets.TF_VAR_DEV }}
      
    defaults:
      run:
        working-directory: ./image-processing-service/infrastructure
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create terraform.tfvars from JSON
        run: |
          cat << 'EOF' > parse_json.py
          import json
          import sys
          
          try:
              data = json.loads(sys.stdin.read())
              
              for key, value in data.items():
                  if isinstance(value, str):
                      print(f'{key} = "{value}"')
                  elif isinstance(value, bool):
                      print(f'{key} = {str(value).lower()}')
                  elif isinstance(value, (int, float)):
                      print(f'{key} = {value}')
                  elif isinstance(value, list):
                      items = ', '.join([f'"{v}"' for v in value])
                      print(f'{key} = [{items}]')
                  elif isinstance(value, dict):
                      print(f'{key} = {{')
                      for k, v in value.items():
                          print(f'  {k} = "{v}"')
                      print('}')
          except json.JSONDecodeError as e:
              sys.exit(1)
          EOF
          
          echo '${{ env.TF_VARS_JSON }}' | python3 parse_json.py > terraform.tfvars

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WIF_PROVIDER }}
          service_account: ${{ env.WIF_SERVICE_ACCOUNT }}

      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        run: |
          terraform init

      - name: Terraform Plan
        run: |
          terraform plan \
          -var="image_tag=${{ github.sha }}" \
          -var="environment=${{ needs.setup.outputs.environment }}" \
          -out=tfplan

      - name: Terraform Apply
        run: |
          terraform apply -auto-approve tfplan

      - name: Terraform Output
        id: tf-output
        run: |
          echo "ðŸ“¤ Terraform Outputs:"
          terraform output -json > terraform-outputs.json
          cat terraform-outputs.json
          
          SERVICE_URL=$(terraform output -raw service_url)
          echo "service_url=${SERVICE_URL}" >> $GITHUB_OUTPUT

      - name: Upload Terraform Outputs
        uses: actions/upload-artifact@v4
        with:
          name: terraform-outputs-${{ needs.setup.outputs.environment }}
          path: image-processing-service/infrastructure/terraform-outputs.json
          retention-days: 30

      - name: Cleanup Sensitive Files
        if: always()
        run: rm -f terraform.tfvars tfplan

    outputs:
      service_url: ${{ steps.tf-output.outputs.service_url }}